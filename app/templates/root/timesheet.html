{% extends "/base.html" %}


{%block imports %}
{% assets "css_timesheet" %}
<link rel="stylesheet" type="text/css" href="{{ ASSET_URL }}" />
<script src="/static/js/timeTools.js"></script>
<script src="/static/js/database.js"></script>
{% endassets %}
<script>
$(document).ready(function(){
  makeTimesheet(TimeTools.testTimesheet);
  // Database.getTimesheet("id").done(function(data){
  //   makeTimesheet(data['timesheet']);
  // });
});

function makeTimesheet(ts){
  var currentInputBox = null;
  var originalText = null;
  var currentTimestap = null;
  var editorTimestamp = null;

  var weeks = TimeTools.getWeeks(ts['clockedIn'], ts['clockedOut']);

  for(var i=weeks.length-1; i>= 0; i--) {
    createWeek(weeks[i]);
  }
  function createWeek(week) {
    var cloned = $("#week-section-template").clone();
    cloned.removeAttr('id');
    cloned.removeAttr('style');

    var sunday = TimeTools.getLastSunday(week['in'][0]);
    cloned.find(".week-header").html("Week of "+TimeTools.monthNames[sunday.getMonth()]+" " + sunday.getDate()+", "+sunday.getFullYear());

    var days = TimeTools.getDays(week['in'], week['out']);
    var dayIndex = 0;
    console.log(week);
    for(var i=0; i<7; i++) {
      var day = null
      if(days.length > dayIndex) {
        var nextDay = days[dayIndex];

        var flatDay = TimeTools.getFlatDay(nextDay['in'][0]);

        if(flatDay.getDay() === i){
          day = nextDay;
          dayIndex++;
        }

      }
      var sundayClone = new Date(sunday.getTime());
      sundayClone.setDate(sundayClone.getDate() + i);
      var flatDay = TimeTools.getFlatDay(sundayClone);
      createDay(i, day, cloned, flatDay);
    }

    $("#weeks-container").append(cloned);
  }
  function createDay(dayIndex, day, rootElement, flatDay) {
    var cloned = $("#day-section-template").clone();
    cloned.removeAttr('id');
    cloned.removeAttr('style');

    cloned.find(".timesheet-day").html(TimeTools.dayNames[dayIndex]);

    var afterElement = cloned.find(".timesheet-day").first();
    if(day != null) {
      for(var i=0; i<day['in'].length; i++) {
        afterElement = createTimeRow(day['in'][i], "in-time", afterElement)
        if(day['out'][i]) {
          afterElement = createTimeRow(day['in'][i], "out-time", afterElement)
        }
      }
    }
    cloned.find(".add-time").click(function(){
      $("#time-edit").appendTo($(event.target).parents(".row").first());
      $("#time-edit").show();
      editorTimestamp = flatDay.getTime();
    });
    rootElement.append(cloned);
  }
  function createTimeRow(time, classType, afterElement) {
    var cloned = $("#clock-row-template").clone();
    cloned.removeAttr('id');
    cloned.removeAttr('style');

    cloned.html(TimeTools.getBasicTime(new Date(time)));
    cloned.addClass(classType);

    cloned.click(function(){
      event.preventDefault();
      if(currentInputBox !== null && !this.isEqualNode(currentInputBox)) {
        updateFromInputBox();
        return false;
      }
      if(!this.isEqualNode(currentInputBox)) {

        updateFromInputBox();
        currentTimestap = time;
        originalText = $(this).text();
        $(this).html('<div class="form-group"><input type="text" class="form-control input-sm error" placeholder="HH:MM" value='+originalText+'></div>');
        currentInputBox = this;
      }
      return false;
    })

    afterElement.after(cloned);

    return cloned;
  }


  $(document).click( function(event) {
    if(currentInputBox) {
      updateFromInputBox();
    }
  });
  $(document).keypress(function(event){
    var keycode = (event.keyCode ? event.keyCode : event.which);
    if(keycode == '13'){
      updateFromInputBox();
    }
  });
  $("#time-edit .reject-new").click(function(){
    $("#time-edit").hide();
  });
  $("#accept-new").click(function() {
    console.log(editorTimestamp);

    var inText = $("#new-clock-in").val();
    var inHourMinutes = TimeTools.parseTextHourMinute(inText);
    var inTime = null;
    var data = {};
    if(inHourMinutes != null){
      var newTime = TimeTools.objectToMS(inHourMinutes);
      var inTime = editorTimestamp + newTime;
      if(inTime) {
        data['clockin'] = inTime;
      }
    }

    var outText = $("#new-clock-out").val();
    var outHourMinutes = TimeTools.parseTextHourMinute(outText);
    var outTime = null;
    if(outHourMinutes != null){
      var newTime = TimeTools.objectToMS(outHourMinutes);
      var outTime = editorTimestamp + newTime;
      if(outTime) {
        data['clockout'] = outTime;
      }
    }

    if(inTime || (inTime && outTime)) {
      Database.createClock(data, GnomonSession.userid).done(function(){
        console.log("created success");
      });
    }
  });
  function updateFromInputBox(timestamp) {
    if(currentInputBox) {
      var newText = $("input", currentInputBox).first().val();

      var hourMinutes = TimeTools.parseTextHourMinute(newText);

      if(hourMinutes != null){
        var newTime = TimeTools.objectToMS(hourMinutes);
        var totalNewTime = TimeTools.getFlatDay(currentTimestap).getTime() + newTime;
        Database.updateClock({"clockOriginal": currentTimestap, "clockReplacement": totalNewTime}, GnomonSession.userid).done(function(){
          alert("update success");
        });
      }
      else{
        console.log("send to server detele: "+currentTimestap);
        Database.deleteClock(currentTimestap, GnomonSession.userid).done(function() {
          alert("delete success");
        });
      }

      var text = originalText;
      if(text === null) {
        text = originalText;
      }
      $(currentInputBox).html(text);
      currentInputBox = null;
    }
  }
}
</script>

{% endblock %}

{% block content %}

<div class="timesheet">

  <div class="col-sm-14 col-xs-14 time" style="display:none;" id="time-edit">
    <div class="row">
      <div class="col-sm-14">
        <div class="form-group">
          <input type="text" class="form-control input-sm" id="new-clock-in" placeholder="HH:MM AM/PM" style="background-color: #daf5d6">
        </div>
      </div>
      <div class="col-sm-14">
        <div class="form-group">
          <input type="text" class="form-control input-sm error" id="new-clock-out" placeholder="HH:MM AM/PM" style="background-color: #ffc7c7">
        </div>
      </div>
      <div class="col-sm-14" style="padding-bottom: 5px;">
        <button type="button" class="btn btn-default btn-xs" id="accept-new">Accept</button>
        <button type="button" class="btn btn-default btn-xs reject-new">Cancel</button>
      </div>
    </div>
  </div>

  <div id="weeks-container" class="container-fluid">



  </div>
</div>
<div class="week-section" id="week-section-template" style="display: none;">
  <div class="row">
    <div class="col-xs-14 text-center" style="background: gray;">
      <h4 class="week-header">Week of November 30, 2014</h4>
    </div>

    <div class="visible-xs col-xs-7 text-center" style="background: gray;">
      In
    </div>

    <div class="visible-xs col-xs-7 text-center" style="background: gray;">
      Out
    </div>
  </div>

  <div class="row week-columns">

  </div>
</div>
<div class="col-sm-2" id="day-section-template" style="display: none;">
  <div class="row">
    <div class="col-sm-14 col-xs-14 timesheet-day">
      Monday
    </div>

    <!-- <div class="col-sm-14 col-xs-7 in-time">
      8:24:01 PM
    </div>

    <div class="col-sm-14 col-xs-7 out-time">
      8:24:59 PM
    </div>

    <div class="col-sm-14 col-xs-7 in-time">
      8:26:30 PM
    </div>

    <div class="col-sm-14 col-xs-7 out-time">
      8:28:10 PM
    </div> -->

    <div class="col-sm-14 col-xs-14 add-time-col">
      <button class="btn btn-default btn-block add-time">
        <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>
      </button>
    </div>
  </div>
</div>
<div class="col-sm-14 col-xs-7" style="display: none;" id="clock-row-template">
</div>
{% endblock %}
